<html>

<head>
    <title>Basic Transmuxer Test</title>
</head>

<body>
    <video controls width="80%"></video>
    <script src="./mux.js"></script>
    <script>
        // Create array of TS files to play
        segments = [
            "./963.ts",
            "./147.ts"
        ];
        // Replace this value with your files codec info
        mime = 'video/mp4; codecs="mp4a.40.2,avc1.64001f"';

        let mediaSource = new MediaSource();
        let transmuxer = new muxjs.mp4.Transmuxer({remux: false});
        console.log(mediaSource)
        video = document.querySelector('video');
        video.src = URL.createObjectURL(mediaSource);
        // video.src = "./test.ts"
        console.log(video.src)
        mediaSource.addEventListener("sourceopen", appendFirstSegment);
        function appendFirstSegment() {
            if (segments.length == 0) {
                return;
            }
            URL.revokeObjectURL(video.src); //解析URL
            sourceBuffer = mediaSource.addSourceBuffer(mime);
            // 监听data事件，开始转换流
            transmuxer.on('data', (segment) => {
                let data = new Uint8Array(segment.initSegment.byteLength + segment.data.byteLength);
                console.log(data);
                data.set(segment.initSegment, 0);
                data.set(segment.data, segment.initSegment.byteLength);
                console.log(muxjs.mp4.tools.inspect(data));
                sourceBuffer.appendBuffer(data);
            })
            fetch(segments.shift()).then((response) => {
                return response.arrayBuffer();
            }).then((response) => {
                console.log(response.byteLength)
                transmuxer.push(new Uint8Array(response));
                transmuxer.flush();
            })
        }

        function appendNextSegment() {
            // reset the 'data' event listener to just append (moof/mdat) boxes to the Source Buffer
            transmuxer.off('data');
            transmuxer.on('data', (segment) => {
                sourceBuffer.appendBuffer(new Uint8Array(segment.data));
            })

            if (segments.length == 0) {
                // notify MSE that we have no more segments to append.
                mediaSource.endOfStream();
            }

            segments.forEach((segment) => {
                // fetch the next segment from the segments array and pass it into the transmuxer.push method
                fetch(segments.shift()).then((response) => {
                    return response.arrayBuffer();
                }).then((response) => {
                    transmuxer.push(new Uint8Array(response));
                    transmuxer.flush();
                })
            })
        }
    </script>
</body>
</html>